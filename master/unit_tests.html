

<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="./">
<head>
  <meta charset="utf-8" /><meta name="viewport" content="width=device-width, initial-scale=1" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Unit Test Quirks &mdash; Typhos 4.1.1.dev19+g32e5da39 documentation</title>
      <link rel="stylesheet" type="text/css" href="_static/pygments.css?v=03e43079" />
      <link rel="stylesheet" type="text/css" href="_static/css/theme.css?v=e59714d7" />

  
      <script src="_static/jquery.js?v=5d32c60e"></script>
      <script src="_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
      <script src="_static/documentation_options.js?v=12ebebfe"></script>
      <script src="_static/doctools.js?v=9a2dae69"></script>
      <script src="_static/sphinx_highlight.js?v=dc90522c"></script>
      <script src="_static/docs-versions-menu.js?v=3d6a1aea"></script>
    <script src="_static/js/theme.js"></script>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="prev" title="Utility Functions" href="utils.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="index.html" class="icon icon-home">
            Typhos
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">User Documentation</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="basic_usage.html">How it Works</a></li>
<li class="toctree-l1"><a class="reference internal" href="tools.html">Supported Tools</a></li>
<li class="toctree-l1"><a class="reference internal" href="save.html">Saving and Loading</a></li>
<li class="toctree-l1"><a class="reference internal" href="connections.html">Application Connections</a></li>
<li class="toctree-l1"><a class="reference internal" href="python_methods.html">Including Python Code</a></li>
<li class="toctree-l1"><a class="reference internal" href="templates.html">Custom Templates</a></li>
<li class="toctree-l1"><a class="reference internal" href="release_notes.html">Release History</a></li>
<li class="toctree-l1"><a class="reference internal" href="upcoming_changes.html">Upcoming Changes</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Developer Documentation</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="cli.html">Command Line Utilities</a></li>
<li class="toctree-l1"><a class="reference internal" href="display.html">Suite and Displays</a></li>
<li class="toctree-l1"><a class="reference internal" href="widgets.html">Widgets</a></li>
<li class="toctree-l1"><a class="reference internal" href="plugins.html">Typhos Data Plugins for PyDM</a></li>
<li class="toctree-l1"><a class="reference internal" href="utils.html">Utility Functions</a></li>
<li class="toctree-l1"><a class="reference internal" href="utils.html#cache-utilities">Cache Utilities</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">Unit Test Quirks</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#things-to-know-for-test-writers">Things to Know for Test Writers</a></li>
<li class="toctree-l2"><a class="reference internal" href="#local-vs-cloud">Local vs Cloud</a></li>
</ul>
</li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="index.html">Typhos</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="index.html" class="icon icon-home" aria-label="Home"></a></li>
      <li class="breadcrumb-item active">Unit Test Quirks</li>
      <li class="wy-breadcrumbs-aside">
            <a href="_sources/unit_tests.rst.txt" rel="nofollow"> View page source</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="unit-test-quirks">
<h1>Unit Test Quirks<a class="headerlink" href="#unit-test-quirks" title="Link to this heading"></a></h1>
<p>Typhos, from time to time, has had issues with its unit tests.
These often manifest as test failures and segmentation faults that only occur
when running the tests on a cloud platform.</p>
<p>By and large, these are related to difficulty with cleaning up resources from
tests that allocate qt widgets.</p>
<section id="things-to-know-for-test-writers">
<h2>Things to Know for Test Writers<a class="headerlink" href="#things-to-know-for-test-writers" title="Link to this heading"></a></h2>
<ul class="simple">
<li><p>Always use the <code class="docutils literal notranslate"><span class="pre">qtbot</span></code> fixture (from the <code class="docutils literal notranslate"><span class="pre">pytest-qt</span></code> package)</p></li>
<li><p>Always call <code class="docutils literal notranslate"><span class="pre">qtbot.add_widget(widget)</span></code> on any widget you create in your test.
This helps clean up your widget after the test is complete.</p></li>
<li><p>Use the <code class="docutils literal notranslate"><span class="pre">qapp</span></code> fixture and call <code class="docutils literal notranslate"><span class="pre">qapp.processEvents()</span></code> if you need “something”
in the qt world to happen.</p></li>
<li><p>Use the <code class="docutils literal notranslate"><span class="pre">noapp</span></code> fixture if you need to test code that calls <code class="docutils literal notranslate"><span class="pre">qapp.exec_()</span></code> or
<code class="docutils literal notranslate"><span class="pre">qapp.exit()</span></code>. Calling this code with no fixture will break the test suite for
all future tests than need the <code class="docutils literal notranslate"><span class="pre">qapp</span></code>.</p></li>
<li><p>If your test is segfaulting, try using the <code class="docutils literal notranslate"><span class="pre">&#64;pytest.mark.no_gc</span></code> decorator
to skip the manual garbage collection step from the <code class="docutils literal notranslate"><span class="pre">pytest_runtest_call</span></code> hook
in <code class="docutils literal notranslate"><span class="pre">conftest.py</span></code>. In some cases (e.g. the positioner widgets) this is an ill-timed
redundant call.</p></li>
<li><p>If an external package’s widgets (and none of ours) are showing up in the
widget cleanup check (also in the <code class="docutils literal notranslate"><span class="pre">pytest_runtest_call</span></code> hook), try using
the <code class="docutils literal notranslate"><span class="pre">&#64;pytest.mark.no_cleanup_check</span></code> decorator. If these come from <code class="docutils literal notranslate"><span class="pre">typhos</span></code>
it’s fairly important to fix the issue, but if they come from an external
package it’s hard to do something about it.</p></li>
</ul>
</section>
<section id="local-vs-cloud">
<h2>Local vs Cloud<a class="headerlink" href="#local-vs-cloud" title="Link to this heading"></a></h2>
<p>There are a few major differences between local and cloud builds, even
on the same architecture:</p>
<ul class="simple">
<li><p>Cloud builds set the environment variable for offscreen rendering (no rendering).
This slightly changes the timing and drastically changes the implementation of
the qt drawing primitives. You can set this yourself locally via
<code class="docutils literal notranslate"><span class="pre">export</span> <span class="pre">QT_QPA_PLUGIN=offscreen</span></code>.</p></li>
<li><p>Cloud builds use the latest versions of packages, which may differ from the ones
you have installed locally.</p></li>
<li><p>Ideally, the test suite should pass both on local hardware with the default
qpa plugin and also on the cloud.</p></li>
</ul>
</section>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="utils.html" class="btn btn-neutral float-left" title="Utility Functions" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2025, SLAC National Accelerator Laboratory.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>